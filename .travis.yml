dist: focal
language: python
python:
  - "3.8"
services:
  - postgresql
addons:
  postgresql: 13
  apt:
    packages:
    - libarchive-dev
    - postgresql-13-postgis-3
    - postgresql-13-postgis-3-scripts
    # for shp2pgsql
    - postgis
    # for python3
    - python3-pytest
    # for osm pbf parser
    - g++
    - libboost-python-dev
    - libosmpbf-dev
    - libprotobuf-dev
    - make
    - pkg-config
    - protobuf-compiler
    # for PyKOpeningHours
    - cmake
    - extra-cmake-modules
    - qtbase5-dev
    - flex
    - bison
install:
  - pip install -r requirements.txt
before_script:
  # configure database
  - psql -c 'CREATE USER osmose;' -U postgres
  - psql -c "ALTER USER osmose WITH PASSWORD '-osmose-';" -U postgres
  - psql -c 'CREATE DATABASE osmose_test;' -U postgres
  - psql -c 'GRANT ALL ON database osmose_test TO osmose;' -U postgres
  - psql -c 'CREATE EXTENSION hstore; CREATE EXTENSION fuzzystrmatch; CREATE EXTENSION unaccent; CREATE EXTENSION postgis;' -U postgres osmose_test
  - psql -c "GRANT SELECT,UPDATE,DELETE ON TABLE spatial_ref_sys TO osmose;" -U postgres osmose_test
  - psql -c "GRANT SELECT,UPDATE,DELETE,INSERT ON TABLE geometry_columns TO osmose;" -U postgres osmose_test
  - echo "localhost:*:osmose_test:osmose:-osmose-" >> ~/.pgpass
  # configure paths used for tmp files
  - sudo mkdir -p /data/work/$USER /data/work/$USER/cache
  - sudo chown $USER /data/work/$USER /data/work/$USER/cache
  # compile osm pbf parser
  - cd modules/osm_pbf_parser && make && cd ../../
env:
  - TEST_SUITE=lint
  - TEST_SUITE=mypy
  - TEST_SUITE=sax
  - TEST_SUITE=merge
  - TEST_SUITE=other
jobs:
  allow_failures:
    - env: TEST_SUITE=merge
    - env: TEST_SUITE=sax
script:
  - ./tools/pytest.sh $TEST_SUITE
